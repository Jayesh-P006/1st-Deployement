{% extends 'base.html' %}

{% block head %}
<style>
  /* Glassmorphism Status Monitor Styles */
  #status-monitor {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
    user-select: none;
  }

  .glass-container {
    backdrop-filter: blur(20px);
    background: rgba(15, 23, 42, 0.4);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    overflow: hidden;
  }

  .monitor-header {
    padding: 12px 20px;
    background: linear-gradient(to right, rgba(30, 41, 59, 0.5), rgba(51, 65, 85, 0.5));
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    cursor: move;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .window-controls {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .window-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
  }

  .dot-red { background: #ff5f56; }
  .dot-yellow { background: #ffbd2e; }
  .dot-green { background: #27c93f; }

  .monitor-title {
    margin-left: 12px;
    color: rgba(255, 255, 255, 0.9);
    font-size: 14px;
    font-weight: 600;
  }

  .minimize-btn {
    background: none;
    border: none;
    color: rgba(255, 255, 255, 0.6);
    cursor: pointer;
    font-size: 18px;
    padding: 0 8px;
  }

  .minimize-btn:hover {
    color: rgba(255, 255, 255, 0.9);
  }

  .monitor-content {
    width: 380px;
    padding: 24px;
  }

  .system-health {
    margin-bottom: 24px;
    padding: 16px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .health-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
  }

  .health-label {
    color: rgba(255, 255, 255, 0.7);
    font-size: 13px;
  }

  .health-status {
    font-size: 18px;
    font-weight: 700;
    color: #10b981;
  }

  .health-bar {
    width: 100%;
    height: 8px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
    overflow: hidden;
  }

  .health-fill {
    height: 100%;
    background: linear-gradient(to right, #10b981, #06b6d4);
    transition: width 0.5s ease;
  }

  .pipeline-nodes {
    space-y: 16px;
  }

  .node-card {
    position: relative;
    padding: 16px;
    background: rgba(16, 185, 129, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    margin-bottom: 16px;
  }

  .node-content {
    display: flex;
    gap: 16px;
    align-items: flex-start;
  }

  .node-icon {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: #10b981;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    box-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
    flex-shrink: 0;
  }

  .node-icon.processing {
    background: #f59e0b;
    box-shadow: 0 0 20px rgba(245, 158, 11, 0.5);
    animation: pulse 2s ease-in-out infinite;
  }

  .node-icon.down {
    background: #ef4444;
    box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
  }

  .node-info {
    flex: 1;
  }

  .node-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 4px;
  }

  .node-name {
    color: #fff;
    font-size: 14px;
    font-weight: 600;
  }

  .node-latency {
    color: rgba(255, 255, 255, 0.5);
    font-size: 12px;
  }

  .node-description {
    color: rgba(255, 255, 255, 0.6);
    font-size: 12px;
    margin-bottom: 4px;
  }

  .node-details {
    color: rgba(255, 255, 255, 0.4);
    font-size: 11px;
    margin-bottom: 8px;
  }

  .node-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 500;
    background: rgba(255, 255, 255, 0.1);
  }

  .badge-operational {
    color: #10b981;
    background: rgba(16, 185, 129, 0.2);
  }

  .badge-processing {
    color: #f59e0b;
    background: rgba(245, 158, 11, 0.2);
  }

  .badge-down {
    color: #ef4444;
    background: rgba(239, 68, 68, 0.2);
  }

  .monitor-footer {
    margin-top: 24px;
    padding-top: 16px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 11px;
  }

  .live-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    color: rgba(255, 255, 255, 0.6);
  }

  .live-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #10b981;
    animation: pulse 2s ease-in-out infinite;
  }

  .last-update {
    color: rgba(255, 255, 255, 0.4);
  }
</style>
{% endblock %}

{% block content %}
<!-- Your existing dashboard content -->
<h1>Dashboard</h1>

<!-- ... rest of your dashboard ... -->

<!-- System Status Monitor Widget -->
<div id="status-monitor">
  <div class="glass-container">
    <div class="monitor-header" id="drag-handle">
      <div class="window-controls">
        <div class="window-dot dot-red"></div>
        <div class="window-dot dot-yellow"></div>
        <div class="window-dot dot-green"></div>
        <span class="monitor-title">System Status Monitor</span>
      </div>
      <button class="minimize-btn" onclick="toggleMonitor()">_</button>
    </div>

    <div class="monitor-content" id="monitor-content">
      <div class="system-health">
        <div class="health-header">
          <span class="health-label">System Health</span>
          <span class="health-status" id="health-status">Excellent</span>
        </div>
        <div class="health-bar">
          <div class="health-fill" id="health-fill" style="width: 80%"></div>
        </div>
      </div>

      <div class="pipeline-nodes" id="pipeline-nodes">
        <!-- Nodes will be populated by JavaScript -->
      </div>

      <div class="monitor-footer">
        <div class="live-indicator">
          <div class="live-dot"></div>
          <span>Live Monitoring</span>
        </div>
        <span class="last-update" id="last-update">Loading...</span>
      </div>
    </div>
  </div>
</div>

<script>
  // Draggable functionality
  const monitor = document.getElementById('status-monitor');
  const dragHandle = document.getElementById('drag-handle');
  let isDragging = false;
  let currentX, currentY, initialX, initialY;

  dragHandle.addEventListener('mousedown', (e) => {
    isDragging = true;
    initialX = e.clientX - monitor.offsetLeft;
    initialY = e.clientY - monitor.offsetTop;
  });

  document.addEventListener('mousemove', (e) => {
    if (isDragging) {
      e.preventDefault();
      currentX = e.clientX - initialX;
      currentY = e.clientY - initialY;
      monitor.style.left = currentX + 'px';
      monitor.style.top = currentY + 'px';
      monitor.style.right = 'auto';
      monitor.style.bottom = 'auto';
    }
  });

  document.addEventListener('mouseup', () => {
    isDragging = false;
  });

  // Toggle minimize
  function toggleMonitor() {
    const content = document.getElementById('monitor-content');
    content.style.display = content.style.display === 'none' ? 'block' : 'none';
  }

  // Fetch and update system status
  async function updateSystemStatus() {
    try {
      const response = await fetch('/api/status/system');
      const data = await response.json();
      
      if (data.error) {
        console.error('Status API error:', data.error);
        return;
      }

      // Update nodes
      const nodesContainer = document.getElementById('pipeline-nodes');
      nodesContainer.innerHTML = '';

      const nodeConfig = [
        { id: 'user-input', name: 'User Input', icon: 'ðŸ‘¤' },
        { id: 'vector-db', name: 'Vector Database', icon: 'ðŸ—„ï¸' },
        { id: 'ai-engine', name: 'AI Engine', icon: 'ðŸ§ ' },
        { id: 'scheduler', name: 'Scheduler Backend', icon: 'âš™ï¸' },
        { id: 'social-api', name: 'Social Media APIs', icon: 'ðŸ“±' }
      ];

      let operationalCount = 0;
      nodeConfig.forEach(node => {
        const nodeData = data[node.id];
        if (nodeData && nodeData.status === 'operational') operationalCount++;

        const statusClass = nodeData ? nodeData.status : 'down';
        const latency = nodeData ? nodeData.latency : 'N/A';
        const details = nodeData ? nodeData.details : 'No data';

        nodesContainer.innerHTML += `
          <div class="node-card">
            <div class="node-content">
              <div class="node-icon ${statusClass}">${node.icon}</div>
              <div class="node-info">
                <div class="node-header">
                  <span class="node-name">${node.name}</span>
                  <span class="node-latency">${latency}</span>
                </div>
                <div class="node-description">${details}</div>
                <span class="node-badge badge-${statusClass}">${statusClass.charAt(0).toUpperCase() + statusClass.slice(1)}</span>
              </div>
            </div>
          </div>
        `;
      });

      // Update health
      const healthPercentage = (operationalCount / nodeConfig.length) * 100;
      document.getElementById('health-fill').style.width = healthPercentage + '%';
      
      let healthText = 'Critical';
      if (healthPercentage === 100) healthText = 'Excellent';
      else if (healthPercentage >= 80) healthText = 'Good';
      else if (healthPercentage >= 60) healthText = 'Fair';
      
      document.getElementById('health-status').textContent = healthText;
      document.getElementById('health-status').style.color = 
        healthPercentage >= 80 ? '#10b981' : healthPercentage >= 60 ? '#f59e0b' : '#ef4444';

      // Update timestamp
      document.getElementById('last-update').textContent = 
        'Last update: ' + new Date().toLocaleTimeString();

    } catch (error) {
      console.error('Failed to fetch system status:', error);
    }
  }

  // Initial update and set interval
  updateSystemStatus();
  setInterval(updateSystemStatus, 5000); // Update every 5 seconds
</script>
{% endblock %}
