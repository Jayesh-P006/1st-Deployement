{% extends 'base.html' %}

{% block title %}DM Conversations{% endblock %}

{% block content %}
<div class="dm-header">
  <div>
    <a href="{{ url_for('settings.index') }}" class="btn secondary">â† Back to Settings</a>
    <h1>Instagram DMs</h1>
    <p>Inbox-style view of your latest conversations and messages.</p>
  </div>
  <form method="POST" action="{{ url_for('settings.sync_conversations') }}" class="dm-sync">
    <button type="submit" class="btn">ğŸ”„ Sync Previous DMs</button>
    <small>Pulls recent conversations/messages via Graph API (requires messaging permissions).</small>
  </form>
</div>

<div class="dm-filters">
  <a href="{{ url_for('settings.conversations', status='all', conversation_id=selected_conversation.id if selected_conversation else None) }}" 
     class="btn secondary {% if status_filter == 'all' %}active{% endif %}">All ({{ status_counts.all }})</a>
  <a href="{{ url_for('settings.conversations', status='active', conversation_id=selected_conversation.id if selected_conversation else None) }}" 
     class="btn secondary {% if status_filter == 'active' %}active{% endif %}">âœ… Active ({{ status_counts.active }})</a>
  <a href="{{ url_for('settings.conversations', status='resolved', conversation_id=selected_conversation.id if selected_conversation else None) }}" 
     class="btn secondary {% if status_filter == 'resolved' %}active{% endif %}">âœ“ Resolved ({{ status_counts.resolved }})</a>
  <a href="{{ url_for('settings.conversations', status='archived', conversation_id=selected_conversation.id if selected_conversation else None) }}" 
     class="btn secondary {% if status_filter == 'archived' %}active{% endif %}">ğŸ“¦ Archived ({{ status_counts.archived }})</a>
</div>

{% if conversations %}
<div class="dm-shell">
  <aside class="dm-list">
    {% for conv in conversations %}
    {% set last_msg = conv.messages.order_by(DMMessage.created_at.desc()).first() %}
    <a href="{{ url_for('settings.conversations', status=status_filter, conversation_id=conv.id) }}"
       class="dm-list-item {% if selected_conversation and conv.id == selected_conversation.id %}active{% endif %}">
      <div class="dm-list-row">
        <div class="dm-avatar">{{ (conv.instagram_username or conv.instagram_user_id)[0:2]|upper }}</div>
        <div class="dm-list-meta">
          <div class="dm-list-top">
            <span class="dm-name">{{ conv.instagram_username or 'User ' + conv.instagram_user_id }}</span>
            <span class="dm-time">{{ (last_msg.created_at.strftime('%b %d, %H:%M')) if last_msg else '' }}</span>
          </div>
          <div class="dm-list-bottom">
            <span class="dm-preview">{{ (last_msg.message_text[:70] + ('â€¦' if last_msg and last_msg.message_text|length > 70 else '')) if last_msg else 'No messages yet' }}</span>
            <span class="dm-status dm-status-{{ conv.conversation_status }}">{{ conv.conversation_status }}</span>
          </div>
        </div>
      </div>
    </a>
    {% endfor %}
  </aside>

  <section class="dm-chat">
    {% if selected_conversation %}
    <div class="dm-chat-header">
      <div>
        <h2>{{ selected_conversation.instagram_username or 'User ' + selected_conversation.instagram_user_id }}</h2>
        <p>{{ selected_conversation.message_count }} messages Â· {{ selected_conversation.auto_reply_count }} auto-replies</p>
      </div>
      <div class="dm-chat-status dm-status-{{ selected_conversation.conversation_status }}">{{ selected_conversation.conversation_status }}</div>
    </div>

    <div class="dm-chat-window">
      {% for message in messages %}
      <div class="dm-bubble-row {% if message.sender_type == 'bot' %}outgoing{% else %}incoming{% endif %}">
        <div class="dm-bubble {% if message.sender_type == 'bot' %}bot{% else %}user{% endif %}">
          <div class="dm-bubble-text">{{ message.message_text }}</div>
          <div class="dm-bubble-meta">
            <span>{{ message.created_at.strftime('%H:%M') }}</span>
            {% if message.is_auto_reply %}<span class="tag">ğŸ¤– Auto-reply</span>{% endif %}
            {% if not message.sent_successfully and message.sender_type == 'bot' %}<span class="tag error">Failed</span>{% endif %}
          </div>
          {% if message.error_message %}
          <div class="dm-bubble-error">âš ï¸ {{ message.error_message }}</div>
          {% endif %}
        </div>
      </div>
      {% endfor %}

      {% if not messages %}
      <div class="dm-empty-chat">No messages yet</div>
      {% endif %}
    </div>

    <!-- Manual reply composer (emoji friendly) -->
    <form class="dm-composer" method="POST" action="{{ url_for('settings.reply_conversation', conversation_id=selected_conversation.id) }}">
      <textarea name="message_text" rows="2" placeholder="Type a reply... emojis supported ğŸ˜Š" required></textarea>
      <button type="submit" class="btn">Send</button>
    </form>
    {% else %}
    <div class="dm-empty-chat">Select a conversation to view messages.</div>
    {% endif %}
  </section>
</div>
{% else %}
<div class="card" style="text-align: center; padding: 60px 20px;">
  <h2 style="color: #999; margin-bottom: 10px;">No conversations found</h2>
  <p style="color: #999;">DM conversations will appear here once users start messaging</p>
</div>
{% endif %}
{% endblock %}
