{% extends 'base.html' %}

{% block title %}DM Conversations{% endblock %}

{% block content %}
<div style="margin-bottom: 20px;">
  <a href="{{ url_for('settings.index') }}" class="btn secondary" style="margin-bottom: 15px;">â† Back to Settings</a>
  <h1 style="margin-bottom: 10px;">ğŸ’¬ DM Conversations</h1>
  <p style="color: #666;">View and manage Instagram direct message conversations</p>

  <form method="POST" action="{{ url_for('settings.sync_conversations') }}" style="margin-top: 12px;">
    <button type="submit" class="btn" style="background: #0a66c2; color: #fff;">
      ğŸ”„ Sync Previous DMs
    </button>
    <small style="display: block; margin-top: 6px; color: #666;">
      Pulls recent Instagram conversations/messages via Graph API (requires messaging permissions).
    </small>
  </form>
</div>

<div style="display: flex; gap: 10px; margin-bottom: 25px; flex-wrap: wrap;">
  <a href="{{ url_for('settings.conversations', status='all') }}" 
     class="btn secondary {% if status_filter == 'all' %}active{% endif %}"
     style="{% if status_filter == 'all' %}background: #0a66c2; color: #fff;{% endif %}">
    All ({{ status_counts.all }})
  </a>
  <a href="{{ url_for('settings.conversations', status='active') }}" 
     class="btn secondary {% if status_filter == 'active' %}active{% endif %}"
     style="{% if status_filter == 'active' %}background: #0a66c2; color: #fff;{% endif %}">
    âœ… Active ({{ status_counts.active }})
  </a>
  <a href="{{ url_for('settings.conversations', status='resolved') }}" 
     class="btn secondary {% if status_filter == 'resolved' %}active{% endif %}"
     style="{% if status_filter == 'resolved' %}background: #0a66c2; color: #fff;{% endif %}">
    âœ“ Resolved ({{ status_counts.resolved }})
  </a>
  <a href="{{ url_for('settings.conversations', status='archived') }}" 
     class="btn secondary {% if status_filter == 'archived' %}active{% endif %}"
     style="{% if status_filter == 'archived' %}background: #0a66c2; color: #fff;{% endif %}">
    ğŸ“¦ Archived ({{ status_counts.archived }})
  </a>
</div>

{% if conversations %}
<div style="display: grid; gap: 15px;">
  {% for conv in conversations %}
  <a href="{{ url_for('settings.view_conversation', conversation_id=conv.id) }}" 
     style="text-decoration: none; color: inherit;">
    <div class="card" style="border-left: 4px solid {% if conv.conversation_status == 'active' %}#28a745{% elif conv.conversation_status == 'resolved' %}#0a66c2{% else %}#6c757d{% endif %}; transition: transform 0.2s, box-shadow 0.2s;"
         onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';"
         onmouseout="this.style.transform=''; this.style.boxShadow='';">
      
      <div style="display: flex; justify-content: space-between; align-items: start;">
        <div style="flex: 1;">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
            <h3 style="margin: 0; color: #1a1a1a;">
              {{ conv.instagram_username or 'User ' + conv.instagram_user_id }}
            </h3>
            <span class="badge" style="background: {% if conv.conversation_status == 'active' %}#28a745{% elif conv.conversation_status == 'resolved' %}#0a66c2{% else %}#6c757d{% endif %}; color: white;">
              {{ conv.conversation_status }}
            </span>
            {% if conv.sentiment %}
            <span class="badge" style="background: {% if conv.sentiment == 'positive' %}#28a745{% elif conv.sentiment == 'negative' %}#dc3545{% else %}#f59e0b{% endif %}; color: white;">
              {% if conv.sentiment == 'positive' %}ğŸ˜Š{% elif conv.sentiment == 'negative' %}ğŸ˜{% else %}ğŸ˜{% endif %} {{ conv.sentiment }}
            </span>
            {% endif %}
          </div>
          
          <div style="display: flex; gap: 20px; margin-bottom: 10px; font-size: 14px; color: #666;">
            <span>ğŸ’¬ {{ conv.message_count }} messages</span>
            <span>ğŸ¤– {{ conv.auto_reply_count }} auto-replies</span>
            <span>ğŸ• Last: {{ conv.last_message_at.strftime('%Y-%m-%d %H:%M') }}</span>
          </div>
          
          {% if conv.notes %}
          <p style="color: #666; margin: 0; font-size: 14px;">ğŸ“ {{ conv.notes[:100] }}{% if conv.notes|length > 100 %}...{% endif %}</p>
          {% endif %}
        </div>
        
        <div style="margin-left: 20px;">
          <span class="btn secondary" style="padding: 8px 15px;">View â†’</span>
        </div>
      </div>
    </div>
  </a>
  {% endfor %}
</div>
{% else %}
<div class="card" style="text-align: center; padding: 60px 20px;">
  <h2 style="color: #999; margin-bottom: 10px;">No conversations found</h2>
  <p style="color: #999;">DM conversations will appear here once users start messaging</p>
</div>
{% endif %}
{% endblock %}
