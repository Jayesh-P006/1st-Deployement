<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DM Conversations</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
  <style>
    /* DM-specific full screen layout */
    :root {
      --dm-header-h: 64px;
    }

    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      height: 100vh;
      height: 100dvh;
      min-height: 100vh;
      background: #f5f7fb;
    }

    /* Subtle animated background ‚Äúgraphics‚Äù (CSS only) */
    .dm-fullscreen-container {
      position: relative;
      height: calc(100vh - var(--dm-header-h));
      height: calc(100dvh - var(--dm-header-h));
      overflow: hidden;
      isolation: isolate;
    }

    .dm-fullscreen-container::before {
      content: "";
      position: absolute;
      inset: -40px;
      background:
        radial-gradient(circle at 10% 10%, rgba(102, 126, 234, 0.16), transparent 45%),
        radial-gradient(circle at 90% 25%, rgba(118, 75, 162, 0.14), transparent 50%),
        radial-gradient(circle at 35% 95%, rgba(10, 102, 194, 0.10), transparent 55%);
      z-index: -1;
      animation: dmFloat 10s ease-in-out infinite alternate;
    }

    @keyframes dmFloat {
      from { transform: translate3d(0, 0, 0) scale(1); }
      to { transform: translate3d(14px, -10px, 0) scale(1.02); }
    }

    @keyframes dmFadeUp {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes dmPop {
      from { opacity: 0; transform: translateY(10px) scale(0.98); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    .dm-fullscreen-header {
      background: #fff;
      border-bottom: 1px solid #e9ecef;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .dm-fullscreen-header::after {
      content: "";
      position: absolute;
      left: 0;
      right: 0;
      bottom: -1px;
      height: 2px;
      background: linear-gradient(90deg, #667eea, #0a66c2, #764ba2);
      opacity: 0.25;
      pointer-events: none;
    }
    .dm-fullscreen-logo {
      display: flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
      color: #1a1a1a;
      font-weight: 700;
      font-size: 1.3rem;
    }
    .dm-fullscreen-logo svg {
      width: 28px;
      height: 28px;
    }
    .dm-header-actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    /* Override global DM sizing (style.css uses 70vh) */
    .dm-shell {
      height: 100% !important;
      min-height: 0;
      animation: dmFadeUp 320ms ease both;
      display: grid;
      grid-template-columns: clamp(280px, 30vw, 380px) 1fr;
      gap: 0;
    }

    .dm-list {
      height: 100% !important;
      max-height: none !important;
      overflow-y: auto;
      overscroll-behavior: contain;
    }

    .dm-list-item {
      animation: dmFadeUp 260ms ease both;
    }

    .dm-chat {
      height: 100% !important;
      max-height: none !important;
      min-height: 0;
    }

    .dm-chat-window {
      height: 100% !important;
      max-height: none !important;
      min-height: 0;
      overflow-y: auto;
      overscroll-behavior: contain;
    }

    .dm-bubble-row {
      animation: dmPop 220ms ease both;
      will-change: transform, opacity;
    }

    /* Slightly smoother hover, more ‚Äúpremium‚Äù feel */
    .dm-list-item:hover {
      transform: translateY(-1px);
    }

    .dm-bubble {
      transition: transform 180ms ease, box-shadow 180ms ease;
    }

    .dm-bubble:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 22px rgba(0,0,0,0.10);
    }
    
    /* Mobile Responsive Styles */
    @media (max-width: 768px) {
      /* Show back button on mobile */
      #backToListBtn {
        display: inline-flex !important;
      }
      
      /* Hide refresh text on mobile */
      .refresh-text {
        display: none;
      }
      
      /* Header adjustments for mobile */
      .dm-fullscreen-header {
        padding: 10px 15px;
      }
      .dm-fullscreen-logo span { 
        display: none; 
      }
      .dm-fullscreen-logo svg { 
        width: 32px; 
        height: 32px; 
      }
      .dm-header-actions .btn span { 
        display: none; 
      }
      .dm-header-actions .btn { 
        padding: 8px 12px;
        min-width: 40px;
      }
      
      /* DM Shell - Stack conversations list and chat vertically on mobile */
      .dm-shell {
        grid-template-columns: 1fr !important;
        height: 100% !important;
      }
      
      /* Conversations list - Show only when no conversation selected */
      .dm-list {
        height: 100% !important;
      }
      
      /* Chat section - Hide list when chat is open on mobile */
      .dm-chat {
        display: none;
      }
      
      /* Show chat and hide list when conversation is selected */
      body.dm-has-chat .dm-list {
        display: none;
      }
      
      body.dm-has-chat .dm-chat {
        display: flex !important;
        height: 100% !important;
        max-height: none !important;
      }
      
      /* Chat header on mobile */
      .dm-chat-header {
        padding: 12px 15px;
        flex-wrap: wrap;
      }
      
      .dm-chat-header h2 {
        font-size: 1.1rem;
      }
      
      .dm-chat-header p {
        font-size: 0.85rem;
      }
      
      .dm-header-badges {
        flex-wrap: wrap;
      }
      
      .dm-header-badges .btn {
        padding: 6px 10px;
        font-size: 0.85rem;
      }
      
      /* Chat window adjustments */
      .dm-chat-window {
        max-height: none !important;
        padding: 12px;
      }
      
      /* Bubble adjustments for mobile */
      .dm-bubble {
        max-width: 85%;
        font-size: 0.9rem;
      }
      
      .dm-bubble-text {
        font-size: 0.9rem;
      }
      
      /* Composer adjustments */
      .dm-composer {
        padding: 12px 15px;
      }
      
      .dm-composer textarea {
        font-size: 16px; /* Prevents zoom on iOS */
      }
      
      .dm-composer .btn {
        padding: 10px 16px;
        font-size: 0.9rem;
      }
      
      /* List item adjustments */
      .dm-list-item {
        padding: 12px 15px;
      }
      
      .dm-avatar {
        width: 42px;
        height: 42px;
        font-size: 1rem;
      }
      
      .dm-name {
        font-size: 0.9rem;
      }
      
      .dm-preview {
        font-size: 0.8rem;
        max-width: 70%;
      }
      
      .dm-time {
        font-size: 0.75rem;
      }
      
      /* Tags and badges */
      .dm-tag {
        font-size: 0.65rem;
        padding: 2px 6px;
      }
      
      .dm-unread-bubble {
        min-width: 18px;
        height: 18px;
        font-size: 0.65rem;
      }
    }
    
    /* Extra small screens (phones in portrait) */
    @media (max-width: 480px) {
      .dm-fullscreen-header {
        padding: 8px 12px;
      }
      
      .dm-header-actions {
        gap: 6px;
      }
      
      .dm-header-actions .btn {
        padding: 6px 10px;
        font-size: 1.1rem;
      }
      
      .dm-bubble {
        max-width: 90%;
        padding: 10px 12px;
      }
      
      .dm-composer {
        padding: 10px 12px;
        gap: 8px;
      }
      
      .dm-composer .btn {
        padding: 8px 12px;
      }
    }
  </style>
</head>
<body class="{% if selected_conversation %}dm-has-chat{% endif %}">

<!-- Minimal Header with Logo Only -->
<div class="dm-fullscreen-header">
  <a href="{{ url_for('collab.drafts') }}" class="dm-fullscreen-logo">
    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zM5 8V6h14v2H5zm2 4h10v2H7v-2z"/></svg>
    <span>PostScheduler</span>
  </a>
  <div class="dm-header-actions">
    <form method="POST" action="{{ url_for('dm.sync_conversations') }}" style="display: inline;">
      <button type="submit" class="btn secondary" style="padding: 8px 14px;">üîÑ <span>Sync</span></button>
    </form>
    <a href="{{ url_for('settings.index') }}" class="btn secondary" style="padding: 8px 14px;">‚öôÔ∏è <span>Settings</span></a>
  </div>
</div>

<div class="dm-fullscreen-container">

{% if conversations %}
<div class="dm-shell" style="height: 100%; border: none; border-radius: 0; margin: 0;">
  <aside class="dm-list">
    {% for conv in conversations %}
    {% set last_msg = conv.messages.order_by(DMMessage.created_at.desc()).first() %}
    <a href="{{ url_for('dm.conversations', conversation_id=conv.id) }}"
       class="dm-list-item {% if selected_conversation and conv.id == selected_conversation.id %}active{% endif %}">
      <div class="dm-list-row">
        <div class="dm-avatar">{{ conv.get_display_name()[0:2]|upper }}</div>
        <div class="dm-list-meta">
          <div class="dm-list-top">
            <span class="dm-name">{{ conv.get_display_name() }}</span>
            <span class="dm-time">{{ (last_msg.created_at.strftime('%b %d, %H:%M')) if last_msg else '' }}</span>
          </div>
          <div class="dm-list-bottom">
            <span class="dm-preview">{{ (last_msg.message_text[:70] + ('‚Ä¶' if last_msg and last_msg.message_text|length > 70 else '')) if last_msg else 'No messages yet' }}</span>
            <div class="dm-badges">
              {% if conv.has_issues() %}
              <span class="dm-tag dm-tag-issue">Issue</span>
              {% endif %}
              {% if conv.has_auto_chat_off_messages() %}
              <span class="dm-tag dm-tag-auto-off">Auto-Chat-Off</span>
              {% endif %}
              {% if conv.unread_count is defined and conv.unread_count and conv.unread_count > 0 %}
              <span class="dm-unread-bubble">{{ conv.unread_count }}</span>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </a>
    {% endfor %}
  </aside>

  <section class="dm-chat">
    {% if selected_conversation %}
    <div class="dm-chat-header">
      <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
        <a href="{{ url_for('dm.conversations') }}" class="btn secondary" style="padding: 6px 10px; display: none;" id="backToListBtn">
          ‚Üê Back
        </a>
        <div>
          <h2>{{ selected_conversation.get_display_name() }}</h2>
          <p>{{ selected_conversation.message_count }} messages ¬∑ {{ selected_conversation.auto_reply_count }} auto-replies</p>
        </div>
      </div>
      <div class="dm-header-badges">
        <button id="refreshBtn" class="btn secondary" style="margin-right: 10px;">
          <span id="refreshIcon">üîÑ</span> <span class="refresh-text">Refresh</span>
        </button>
        {% if selected_conversation.has_issues() %}
        <span class="dm-tag dm-tag-issue">Issue</span>
        {% endif %}
        {% if selected_conversation.has_auto_chat_off_messages() %}
        <span class="dm-tag dm-tag-auto-off">Auto-Chat-Off</span>
        {% endif %}
      </div>
    </div>

    <div class="dm-chat-window" id="chatWindow">
      {% for message in messages %}
      <div class="dm-bubble-row {% if message.sender_type == 'bot' %}outgoing{% else %}incoming{% endif %}" data-message-id="{{ message.id }}">
        <div class="dm-bubble {% if message.sender_type == 'bot' %}bot{% else %}user{% endif %}">
          <div class="dm-bubble-text">{{ message.message_text }}</div>
          <div class="dm-bubble-meta">
            <span>{{ message.created_at.strftime('%H:%M') }}</span>
            {% if message.is_auto_reply %}<span class="tag">ü§ñ Auto-reply</span>{% endif %}
            {% if not message.sent_successfully and message.sender_type == 'bot' %}<span class="tag error">Failed</span>{% endif %}
          </div>
          {% if message.error_message %}
          <div class="dm-bubble-error">‚ö†Ô∏è {{ message.error_message }}</div>
          {% endif %}
        </div>
      </div>
      {% endfor %}

      {% if not messages %}
      <div class="dm-empty-chat">No messages yet</div>
      {% endif %}
    </div>

    <!-- Manual reply composer (emoji friendly) -->
    <form class="dm-composer" method="POST" action="{{ url_for('dm.reply_conversation', conversation_id=selected_conversation.id) }}" id="replyForm">
      <textarea name="message_text" rows="2" placeholder="Type a reply... emojis supported üòä" required id="messageInput"></textarea>
      <button type="submit" class="btn">Send</button>
    </form>
    {% else %}
    <div class="dm-empty-chat">Select a conversation to view messages.</div>
    {% endif %}
  </section>
</div>
{% else %}
<div style="text-align: center; padding: 60px 20px; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center;">
  <h2 style="color: #999; margin-bottom: 10px;">No conversations found</h2>
  <p style="color: #999;">DM conversations will appear here once users start messaging</p>
</div>
{% endif %}

</div><!-- Close dm-fullscreen-container -->

<script>
  // Keep DM container perfectly fitted to viewport
  (function () {
    const header = document.querySelector('.dm-fullscreen-header');
    function setHeaderHeightVar() {
      if (!header) return;
      const h = Math.ceil(header.getBoundingClientRect().height);
      document.documentElement.style.setProperty('--dm-header-h', h + 'px');
    }
    setHeaderHeightVar();
    window.addEventListener('resize', setHeaderHeightVar);
  })();
</script>

{% if selected_conversation %}
<script>
// Real-time message polling - fetch new messages every 3 seconds
const CONVERSATION_ID = {{ selected_conversation.id }};
let lastMessageCount = {{ messages|length }};
let isPolling = true;

function scrollToBottom() {
  const chatWindow = document.getElementById('chatWindow');
  if (chatWindow) {
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }
}

function createMessageBubble(msg) {
  const row = document.createElement('div');
  row.className = `dm-bubble-row ${msg.sender_type === 'bot' ? 'outgoing' : 'incoming'}`;
  row.setAttribute('data-message-id', msg.id);
  
  const bubble = document.createElement('div');
  bubble.className = `dm-bubble ${msg.sender_type === 'bot' ? 'bot' : 'user'}`;
  
  const text = document.createElement('div');
  text.className = 'dm-bubble-text';
  text.textContent = msg.message_text;
  bubble.appendChild(text);
  
  const meta = document.createElement('div');
  meta.className = 'dm-bubble-meta';
  
  const time = document.createElement('span');
  time.textContent = msg.created_at_time;
  meta.appendChild(time);
  
  if (msg.is_auto_reply) {
    const tag = document.createElement('span');
    tag.className = 'tag';
    tag.textContent = 'ü§ñ Auto-reply';
    meta.appendChild(tag);
  }
  
  if (!msg.sent_successfully && msg.sender_type === 'bot') {
    const errorTag = document.createElement('span');
    errorTag.className = 'tag error';
    errorTag.textContent = 'Failed';
    meta.appendChild(errorTag);
  }
  
  bubble.appendChild(meta);
  
  if (msg.error_message) {
    const error = document.createElement('div');
    error.className = 'dm-bubble-error';
    error.textContent = '‚ö†Ô∏è ' + msg.error_message;
    bubble.appendChild(error);
  }
  
  row.appendChild(bubble);
  return row;
}

async function refreshMessages(isManual = false) {
  const refreshBtn = document.getElementById('refreshBtn');
  const refreshIcon = document.getElementById('refreshIcon');
  
  if (isManual && refreshBtn) {
    refreshBtn.disabled = true;
    refreshIcon.style.display = 'inline-block';
    refreshIcon.style.animation = 'spin 1s linear infinite';
  }
  
  try {
    const response = await fetch(`/dm/api/messages/${CONVERSATION_ID}`);
    const data = await response.json();
    
    if (data.success && data.messages.length > lastMessageCount) {
      // New messages arrived - update chat container only
      const chatWindow = document.getElementById('chatWindow');
      const existingIds = new Set(
        Array.from(chatWindow.querySelectorAll('[data-message-id]'))
          .map(el => parseInt(el.getAttribute('data-message-id')))
      );
      
      data.messages.forEach(msg => {
        if (!existingIds.has(msg.id)) {
          const bubble = createMessageBubble(msg);
          chatWindow.appendChild(bubble);
          existingIds.add(msg.id);
        }
      });
      
      lastMessageCount = data.messages.length;
      scrollToBottom();
      
      // Update conversation header count
      const headerP = document.querySelector('.dm-chat-header p');
      if (headerP) {
        const parts = headerP.textContent.split('¬∑');
        if (parts.length >= 2) {
          headerP.textContent = `${data.message_count} messages ¬∑ ${parts[1].trim()}`;
        }
      }
    }
  } catch (error) {
    console.error('Failed to refresh messages:', error);
  } finally {
    if (isManual && refreshBtn) {
      refreshBtn.disabled = false;
      refreshIcon.style.animation = '';
    }
  }
}

// Auto-refresh chat container only (every 3 seconds)
setInterval(() => refreshMessages(false), 3000);

// Add CSS for spin animation
const style = document.createElement('style');
style.textContent = `
  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }
`;
document.head.appendChild(style);

// Scroll to bottom on load
scrollToBottom();

// Handle manual refresh button click
document.getElementById('refreshBtn')?.addEventListener('click', () => refreshMessages(true));

// Handle form submission with AJAX for smoother UX
document.getElementById('replyForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const formData = new FormData(e.target);
  const messageText = formData.get('message_text');
  
  if (!messageText.trim()) return;
  
  try {
    const response = await fetch(e.target.action, {
      method: 'POST',
      body: formData
    });
    
    if (response.ok) {
      // Clear input
      document.getElementById('messageInput').value = '';
      
      // Trigger immediate poll to show sent message
      setTimeout(() => refreshMessages(false), 500);
    }
  } catch (error) {
    console.error('Failed to send reply:', error);
    // Fallback to normal form submission
    e.target.submit();
  }
});
</script>
{% endif %}

</body>
</html>
