{% extends 'base.html' %}

{% block title %}Chat Control Settings{% endblock %}

{% block content %}
<style>
/* ================= THEME TOKENS (MATCH DRAFT PAGE) ================= */
:root {
  --primary: #6366f1;
  --primary-soft: #818cf8;
  --secondary: #7c3aed;

  --success: #22c55e;
  --warning: #f59e0b;
  --danger: #ef4444;

  --bg-main: #eef1ff;
  --bg-card: rgba(255,255,255,0.92);

  --text-main: #1f2937;
  --text-muted: #6b7280;

  --radius-lg: 18px;
  --radius-md: 14px;

  --shadow-soft: 0 12px 35px rgba(99,102,241,0.18);
  --shadow-hover: 0 28px 70px rgba(99,102,241,0.35);
}


/* ================= PAGE BACKGROUND ================= */
body {
  background:
    radial-gradient(circle at top right, rgba(99,102,241,0.35), transparent 45%),
    radial-gradient(circle at bottom left, rgba(124,58,237,0.35), transparent 45%),
    linear-gradient(180deg, #f7f9ff, #eef1ff);
  color: var(--text-main);
  font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
}

/* ================= HEADERS ================= */
h1 {
  font-weight: 900;
  letter-spacing: -0.6px;
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

h2, h3 {
  font-weight: 800;
  letter-spacing: -0.3px;
  color: #1e1b4b;
}

/* ================= GLOBAL CARDS ================= */
div[style*="background: #fff"] {
  background: var(--bg-card) !important;
  border-radius: var(--radius-lg) !important;
  border: none !important;
  box-shadow: var(--shadow-soft);
  transition: all 0.35s ease;
}

div[style*="background: #fff"]:hover {
  transform: translateY(-6px);
  box-shadow: var(--shadow-hover);
}

/* ================= WARNING BANNER ================= */
div[style*="Instagram Messaging Permission Required"] {
  background: linear-gradient(135deg, #fff7e6, #fff2cc) !important;
  border-radius: var(--radius-md);
  box-shadow: 0 18px 40px rgba(245,158,11,0.35);
}

/* ================= STATS DASHBOARD ================= */
div[style*="grid-template-columns: repeat(4"] > div {
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-soft);
  transition: transform .3s ease, box-shadow .3s ease;
}

div[style*="grid-template-columns: repeat(4"] > div:hover {
  transform: translateY(-6px);
  box-shadow: var(--shadow-hover);
}

/* ================= STAT NUMBERS ================= */
div[style*="font-size: 24px"] {
  font-weight: 900;
  letter-spacing: -0.4px;
}

/* ================= QUICK CONTROL FORMS ================= */
form[style*="justify-content: space-between"] {
  border-radius: var(--radius-lg) !important;
  padding: 16px !important;
  box-shadow: var(--shadow-soft);
  transition: all .3s ease;
}

form[style*="justify-content: space-between"]:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-hover);
}

/* ================= BUTTONS ================= */
button.btn,
a.btn {
  border-radius: 999px !important;
  font-weight: 700;
  letter-spacing: .3px;
  transition: all .25s ease;
}

button.btn:hover,
a.btn:hover {
  transform: translateY(-2px);
}

/* ================= PRIMARY BUTTON ================= */
button.btn {
  background: linear-gradient(135deg, var(--primary), var(--secondary)) !important;
  box-shadow: 0 14px 35px rgba(99,102,241,0.45);
}

/* ================= INPUTS ================= */
input,
textarea {
  border-radius: var(--radius-md) !important;
  background: #f9fafb !important;
  border: 1.5px solid rgba(99,102,241,0.25) !important;
  transition: all .25s ease;
}

input:focus,
textarea:focus {
  border-color: var(--primary) !important;
  box-shadow: 0 0 0 4px rgba(99,102,241,0.25);
  background: #ffffff !important;
}

/* ================= DETAIL SECTIONS ================= */
div[style*="border: 1.5px solid"] {
  border: none !important;
  background: linear-gradient(180deg, #ffffff, #f6f7ff) !important;
  border-radius: var(--radius-lg) !important;
  box-shadow: inset 0 0 0 1px rgba(99,102,241,.12);
}

/* ================= MUTED TEXT ================= */
p, small {
  color: var(--text-muted) !important;
  font-weight: 500;
}

/* ================= SCROLL ================= */
div[style*="overflow-y: auto"] {
  scrollbar-width: thin;
  scrollbar-color: var(--primary) transparent;
}
@media (max-width: 768px) {

  /* REMOVE INNER SCROLL COMPLETELY */
  div[style*="flex: 1; overflow-y: auto"] {
    overflow-y: visible !important;
    padding-right: 0 !important;
  }

  /* Remove forced viewport height */
  div[style*="height: calc(100vh"] {
    height: auto !important;
  }

  /* Page spacing */
  body {
    padding-bottom: 80px;
  }

  /* Header text scaling */
  h1 {
    font-size: 1.35rem !important;
  }

  /* Stats ‚Üí single column */
  div[style*="grid-template-columns: repeat(4"] {
    grid-template-columns: 1fr !important;
  }

  /* Cards spacing */
  div[style*="background: #fff"] {
    border-radius: 16px !important;
  }

  /* Quick toggle forms stack vertically */
  form[style*="justify-content: space-between"] {
    flex-direction: column !important;
    align-items: flex-start !important;
    gap: 10px !important;
  }

  form[style*="justify-content: space-between"] button {
    width: 100% !important;
  }

  /* Buttons full-width */
  button.btn,
  a.btn {
    width: 100% !important;
    text-align: center;
  }

  /* Inputs bigger for touch */
  input,
  textarea {
    font-size: 16px !important;
    padding: 10px !important;
  }

  /* Center bottom link */
  a.btn.secondary {
    width: 100% !important;
  }
}
@media (max-width: 1024px) {
  /* Reduce page height lock */
  div[style*="height: calc(100vh"] {
    height: auto !important;
  }

  /* Stats: 2 columns instead of 4 */
  div[style*="grid-template-columns: repeat(4"] {
    grid-template-columns: repeat(2, 1fr) !important;
  }

  /* Rate limit & time grids ‚Üí stacked */
  div[style*="grid-template-columns: 1fr 1fr"] {
    grid-template-columns: 1fr !important;
  }

  /* Slightly tighter padding */
  div[style*="padding: 16px"] {
    padding: 14px !important;
  }
}


</style>
<div style="display: flex; flex-direction: column; height: calc(100vh - 140px); overflow: hidden;">
  <!-- Fixed Header -->
  <div style="flex-shrink: 0; margin-bottom: 12px;">
    <h1 style="margin: 0 0 4px 0; font-size: 1.6rem;">‚öôÔ∏è Chat Control Settings</h1>
    <p style="color: #666; font-size: 0.9rem; margin: 0;">Configure auto-reply automation, rate limits, and restrictions</p>
  </div>

  <!-- Instagram API Permission Notice -->
  <div style="background: #fff3cd; border: 1.5px solid #ffc107; border-radius: 6px; padding: 10px 12px; margin-bottom: 12px; display: flex; gap: 10px; flex-shrink: 0;">
    <div style="font-size: 20px; flex-shrink: 0;">‚ö†Ô∏è</div>
    <div style="font-size: 0.85rem;">
      <strong style="color: #856404;">Instagram Messaging Permission Required</strong> ‚Äî 
      <span style="color: #856404;">Your app can receive DMs but not send. Request <strong>instagram_manage_messages</strong> at <a href="https://developers.facebook.com/apps/" target="_blank" style="color: #0a66c2;">Meta for Developers</a> ‚Üí App Review.</span>
    </div>
  </div>

  <!-- Statistics Dashboard -->
  <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 12px; flex-shrink: 0;">
    <div style="background: #fff; padding: 12px; border-radius: 6px; border: 1px solid #e9ecef; text-align: center;">
      <div style="font-size: 24px; font-weight: bold; color: #0a66c2;">{{ stats.total_conversations }}</div>
      <div style="color: #666; margin-top: 2px; font-size: 0.8rem;">Total Conversations</div>
    </div>
    <div style="background: #fff; padding: 12px; border-radius: 6px; border: 1px solid #e9ecef; text-align: center;">
      <div style="font-size: 24px; font-weight: bold; color: #28a745;">{{ stats.active_conversations }}</div>
      <div style="color: #666; margin-top: 2px; font-size: 0.8rem;">Active</div>
    </div>
    <div style="background: #fff; padding: 12px; border-radius: 6px; border: 1px solid #e9ecef; text-align: center;">
      <div style="font-size: 24px; font-weight: bold; color: #f59e0b;">{{ stats.auto_replies_24h }}</div>
      <div style="color: #666; margin-top: 2px; font-size: 0.8rem;">Replies (24h)</div>
    </div>
    <div style="background: #fff; padding: 12px; border-radius: 6px; border: 1px solid #e9ecef; text-align: center;">
      <div style="font-size: 24px; font-weight: bold; color: {% if stats.remaining_1h > 0 %}#28a745{% else %}#dc3545{% endif %};">
        {{ stats.auto_replies_1h }}/{{ stats.rate_limit_1h }}
      </div>
      <div style="color: #666; margin-top: 2px; font-size: 0.8rem;">Usage (1h)</div>
    </div>
  </div>

  <!-- Scrollable Content Area -->
  <div  style="flex: 1; overflow-y: auto; padding-right: 8px;">
    <!-- Quick Toggles -->
    <div style="background: #fff; border-radius: 8px; padding: 16px; border: 1px solid #e9ecef; margin-bottom: 12px;">
      <h2 style="margin: 0 0 12px 0; font-size: 1.1rem;">üéõÔ∏è Quick Controls</h2>
      
      <div style="display: grid; gap: 10px;">
        <form method="POST" action="{{ url_for('settings.toggle_setting', setting_name='auto_reply') }}" style="display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; background: {% if settings.auto_reply_enabled %}#d4edda{% else %}#f8d7da{% endif %}; border-radius: 6px;">
          <div>
            <h3 style="margin: 0 0 2px 0; font-size: 0.95rem;">ü§ñ Auto-Reply to DMs</h3>
            <p style="margin: 0; color: #666; font-size: 0.8rem;">Automatically respond to Instagram direct messages using AI</p>
          </div>
          <button type="submit" class="btn" style="background: {% if settings.auto_reply_enabled %}#28a745{% else %}#6c757d{% endif %}; color: #fff; min-width: 80px; padding: 0.5rem 1rem;">
            {% if settings.auto_reply_enabled %}‚úì ON{% else %}‚úó OFF{% endif %}
          </button>
        </form>

        <form method="POST" action="{{ url_for('settings.toggle_setting', setting_name='auto_comment') }}" style="display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; background: {% if settings.auto_comment_enabled %}#d4edda{% else %}#f8d7da{% endif %}; border-radius: 6px;">
          <div>
            <h3 style="margin: 0 0 2px 0; font-size: 0.95rem;">üí¨ Auto-Comment on Posts</h3>
            <p style="margin: 0; color: #666; font-size: 0.8rem;">Automatically respond to comments on posts (Coming Soon)</p>
          </div>
          <button type="submit" class="btn" style="background: {% if settings.auto_comment_enabled %}#28a745{% else %}#6c757d{% endif %}; color: #fff; min-width: 80px; padding: 0.5rem 1rem;">
            {% if settings.auto_comment_enabled %}‚úì ON{% else %}‚úó OFF{% endif %}
          </button>
        </form>

        <form method="POST" action="{{ url_for('settings.toggle_setting', setting_name='business_hours') }}" style="display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; background: {% if settings.business_hours_only %}#d4edda{% else %}#f8d7da{% endif %}; border-radius: 6px;">
          <div>
            <h3 style="margin: 0 0 2px 0; font-size: 0.95rem;">üïê Business Hours Only</h3>
            <p style="margin: 0; color: #666; font-size: 0.8rem;">Restrict auto-replies to business hours ({{ settings.business_hours_start }} - {{ settings.business_hours_end }})</p>
          </div>
          <button type="submit" class="btn" style="background: {% if settings.business_hours_only %}#28a745{% else %}#6c757d{% endif %}; color: #fff; min-width: 80px; padding: 0.5rem 1rem;">
            {% if settings.business_hours_only %}‚úì ON{% else %}‚úó OFF{% endif %}
          </button>
        </form>
      </div>
    </div>

    <!-- Detailed Settings Form -->
    <div style="background: #fff; border-radius: 8px; padding: 16px; border: 1px solid #e9ecef; margin-bottom: 12px;">
      <h2 style="margin: 0 0 12px 0; font-size: 1.1rem;">üìã Detailed Settings</h2>
      
      <form method="POST" action="{{ url_for('settings.update_settings') }}">
        
        <div style="border: 1.5px solid #e9ecef; border-radius: 6px; padding: 12px; margin-bottom: 12px;">
          <h3 style="margin: 0 0 10px 0; font-size: 1rem;">‚è±Ô∏è Rate Limits</h3>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div>
              <label style="display: block; margin-bottom: 4px; font-weight: 500; font-size: 0.85rem;">DM Reply Rate Limit (per hour)</label>
              <input type="number" name="reply_rate_limit" value="{{ settings.reply_rate_limit }}" min="1" max="100"
                     style="width: 100%; padding: 8px; border: 1.5px solid #e9ecef; border-radius: 4px; font-size: 0.9rem;">
              <small style="color: #666; font-size: 0.75rem;">Maximum auto-replies per hour</small>
            </div>
            
            <div>
              <label style="display: block; margin-bottom: 4px; font-weight: 500; font-size: 0.85rem;">Comment Rate Limit (per hour)</label>
              <input type="number" name="comment_rate_limit" value="{{ settings.comment_rate_limit }}" min="1" max="100"
                     style="width: 100%; padding: 8px; border: 1.5px solid #e9ecef; border-radius: 4px; font-size: 0.9rem;">
              <small style="color: #666; font-size: 0.75rem;">Maximum auto-comments per hour</small>
            </div>
          </div>
        </div>

        <div style="border: 1.5px solid #e9ecef; border-radius: 6px; padding: 12px; margin-bottom: 12px;">
          <h3 style="margin: 0 0 10px 0; font-size: 1rem;">üïê Business Hours</h3>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div>
              <label style="display: block; margin-bottom: 4px; font-weight: 500; font-size: 0.85rem;">Start Time</label>
              <input type="time" name="business_hours_start" value="{{ settings.business_hours_start }}"
                     style="width: 100%; padding: 8px; border: 1.5px solid #e9ecef; border-radius: 4px; font-size: 0.9rem;">
            </div>
            
            <div>
              <label style="display: block; margin-bottom: 4px; font-weight: 500; font-size: 0.85rem;">End Time</label>
              <input type="time" name="business_hours_end" value="{{ settings.business_hours_end }}"
                     style="width: 100%; padding: 8px; border: 1.5px solid #e9ecef; border-radius: 4px; font-size: 0.9rem;">
            </div>
          </div>
        </div>

        <div style="border: 1.5px solid #e9ecef; border-radius: 6px; padding: 12px; margin-bottom: 12px;">
          <h3 style="margin: 0 0 10px 0; font-size: 1rem;">üí¨ Default Messages</h3>
          
          <div style="margin-bottom: 12px;">
            <label style="display: block; margin-bottom: 4px; font-weight: 500; font-size: 0.85rem;">Default Greeting</label>
            <textarea name="default_greeting" rows="2"
                      style="width: 100%; padding: 8px; border: 1.5px solid #e9ecef; border-radius: 4px; font-family: inherit; font-size: 0.9rem;">{{ settings.default_greeting }}</textarea>
            <small style="color: #666; font-size: 0.75rem;">Initial message for new conversations</small>
          </div>
          
          <div>
            <label style="display: block; margin-bottom: 4px; font-weight: 500; font-size: 0.85rem;">Fallback Message</label>
            <textarea name="fallback_message" rows="2"
                      style="width: 100%; padding: 8px; border: 1.5px solid #e9ecef; border-radius: 4px; font-family: inherit; font-size: 0.9rem;">{{ settings.fallback_message }}</textarea>
            <small style="color: #666; font-size: 0.75rem;">Message when AI fails to generate a response</small>
          </div>
        </div>

        <div style="border: 1.5px solid #e9ecef; border-radius: 6px; padding: 12px; margin-bottom: 12px;">
          <h3 style="margin: 0 0 10px 0; font-size: 1rem;">üö´ Blacklist Keywords</h3>
          
          <input type="text" name="blacklist_keywords" value="{{ blacklist|join(', ') }}"
                 placeholder="E.g., spam, advertisement, promo"
                 style="width: 100%; padding: 8px; border: 1.5px solid #e9ecef; border-radius: 4px; margin-bottom: 4px; font-size: 0.9rem;">
          <small style="color: #666; font-size: 0.75rem;">Comma-separated keywords. Messages containing these will not get auto-replies</small>
        </div>

        <div style="border: 1.5px solid #e9ecef; border-radius: 6px; padding: 12px; margin-bottom: 12px;">
          <h3 style="margin: 0 0 10px 0; font-size: 1rem;">‚≠ê Whitelist Users</h3>
          
          <input type="text" name="whitelist_users" value="{{ whitelist|join(', ') }}"
                 placeholder="E.g., @vipuser, @partner"
                 style="width: 100%; padding: 8px; border: 1.5px solid #e9ecef; border-radius: 4px; margin-bottom: 4px; font-size: 0.9rem;">
          <small style="color: #666; font-size: 0.75rem;">Comma-separated usernames for priority handling (future feature)</small>
        </div>

        <button type="submit" class="btn" style="background: #0a66c2; color: #fff; width: 100%; padding: 0.65rem;">
          üíæ Save All Settings
        </button>
      </form>
    </div>

    <div style="text-align: center; margin-bottom: 12px;">
      <a href="{{ url_for('settings.conversations') }}" class="btn secondary" style="padding: 0.65rem 1.2rem;">
        üí¨ View DM Conversations
      </a>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Auto-refresh disabled to reduce unnecessary API calls
// Stats will update on page refresh
console.log('Chat controls loaded');
</script>
{% endblock %}
